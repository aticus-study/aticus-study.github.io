var boysAvgHW = [[3.3464, 49.8842],[4.4709, 54.7244],[5.5675, 58.4249],[6.3762, 61.4292],[7.0023, 63.886],[7.5105, 65.9026],[7.934, 67.6236],[8.297, 69.1645],[8.6151, 70.5994],[8.9014, 71.9687],[9.1649, 73.2812],[9.4122, 74.5388],[9.6479, 75.7488],[9.8749, 76.9186],[10.0953, 78.0497],[10.3108, 79.1458],[10.5228, 80.2113],[10.7319, 81.2487],[10.9385, 82.2587],[11.143, 83.2418],[11.3462, 84.1996],[11.5486, 85.1348],[11.7504, 86.0477],[11.9514, 86.941],[12.67076, 86.4522],[12.88102, 87.65247],[13.01842, 88.42326],[13.1545, 89.17549],[13.2899, 89.91041],[13.42519, 90.62908],[13.56088, 91.33242],[13.69738, 92.02127],[13.83505, 92.69638],[13.97418, 93.35847],[14.11503, 94.00823],[14.2578, 94.64637],[14.40263, 95.27359],[14.54965, 95.91475],[14.69893, 96.54734],[14.85054, 97.17191],[15.00449, 97.78898],[15.16078, 98.39903],[15.3194, 99.00254],[15.4803, 99.59998],[15.64343, 100.1918],[15.80873, 100.7783],[15.9761, 101.36],[16.14548, 101.9373],[16.31677, 102.5105],[16.48986, 103.0799],[16.66468, 103.6459],[16.8411, 104.2087],[17.01904, 104.7687],[17.19839, 105.3262],[17.37906, 105.8813],[17.56096, 106.4343],[17.744, 106.9855],[17.92809, 107.535],[18.11316, 108.083],[18.29912, 108.6296],[18.48592, 109.1751],[18.6735, 109.7196],[18.8618, 110.2631],[19.05077, 110.8058],[19.24037, 111.3477],[19.43058, 111.889],[19.62136, 112.4296],[19.8127, 112.9696],[20.00459, 113.509],[20.19703, 114.0479],[20.39002, 114.5861],[20.58357, 115.1238],[20.7777, 115.6609],[20.97243, 116.1973],[21.16779, 116.7329],[21.36383, 117.2678],[21.56058, 117.8018],[21.75811, 118.3348],[21.95645, 118.8668],[22.15567, 119.3977],[22.35584, 119.9272],[22.55702, 120.4554],[22.7593, 120.9821],[22.96273, 121.5072],[23.16742, 122.0305],[23.37343, 122.552],[23.58086, 123.0714],[23.78979, 123.5886],[24.00031, 124.1035],[24.21251, 124.616],[24.42648, 125.1259],[24.64231, 125.6331],[24.8601, 126.1374],[25.07992, 126.6388],[25.30189, 127.137],[25.52607, 127.632],[25.75257, 128.1237],[25.98146, 128.6119],[26.21284, 129.0966],[26.44679, 129.5777],[26.68339, 130.055],[26.92273, 130.5286],[27.16489, 130.9983],[27.40995, 131.4641],[27.65797, 131.926],[27.90904, 132.384],[28.16324, 132.8381],[28.42064, 133.2882],[28.6813, 133.7345],[28.9453, 134.1769],[29.21271, 134.6155],[29.48359, 135.0504],[29.758, 135.4818],[30.03602, 135.9097],[30.3177, 136.3343],[30.60311, 136.7557],[30.8923, 137.1742],[31.18533, 137.5899],[31.48225, 138.0032],[31.78312, 138.4143],[32.08799, 138.8234],[32.3969, 139.231],[32.70991, 139.6373],[33.02704, 140.0427],[33.34835, 140.4477],[33.67387, 140.8527],[34.00363, 141.2582],[34.33766, 141.6646],[34.67599, 142.0725],[35.01864, 142.4824],[35.36562, 142.8949],[35.71695, 143.3107],[36.07263, 143.7304],[36.43266, 144.1545],[36.79704, 144.5838],[37.16577, 145.019],[37.53881, 145.4607],[37.91616, 145.9097],[38.29777, 146.3665],[38.68361, 146.832],[39.07364, 147.3066],[39.46781, 147.7911],[39.86604, 148.2859],[40.26828, 148.7917],[40.67444, 149.3088],[41.08443, 149.8376],[41.49817, 150.3784],[41.91555, 150.9313],[42.33644, 151.4964],[42.76073, 152.0735],[43.18828, 152.6624],[43.61896, 153.2627],[44.05259, 153.8738],[44.48903, 154.4951],[44.92809, 155.1255],[45.3696, 155.7642],[45.81336, 156.4099],[46.25917, 157.0612],[46.70681, 157.7168],[47.15606, 158.3751],[47.60669, 159.0344],[48.05847, 159.6931],[48.51113, 160.3493],[48.96443, 161.0015],[49.4181, 161.6478],[49.87187, 162.2865],[50.32546, 162.9161],[50.77859, 163.535],[51.23096, 164.1418],[51.68229, 164.7352],[52.13226, 165.314],[52.58059, 165.8771],[53.02696, 166.4236],[53.47107, 166.9528],[53.91261, 167.4641],[54.35128, 167.9571],[54.78677, 168.4313],[55.21878, 168.8867],[55.64701, 169.3231],[56.07116, 169.7405],[56.49096, 170.1393],[56.90611, 170.5195],[57.31634, 170.8815],[57.72139, 171.2257],[58.121, 171.5525],[58.51492, 171.8626],[58.90293, 172.1563],[59.2848, 172.4343],[59.66033, 172.6972],[60.02932, 172.9456],[60.39159, 173.1801],[60.74699, 173.4014],[61.09537, 173.6101],[61.4366, 173.8067],[61.77057, 173.992],[62.09719, 174.1665],[62.41639, 174.3308],[62.72809, 174.4854],[63.03228, 174.631],[63.32892, 174.768],[63.61802, 174.8969],[63.89959, 175.0182],[64.17367, 175.1323],[64.44032, 175.2398],[64.69961, 175.341],[64.95165, 175.4362],[65.19653, 175.5259],[65.4344, 175.6104],[65.6654, 175.6901],[65.8897, 175.7652],[66.10749, 175.836],[66.31897, 175.9028],[66.52437, 175.9658],[66.7239, 176.0254],[66.91784, 176.0816],[67.10642, 176.1348],[67.28993, 176.185],[67.46863, 176.2326],[67.64281, 176.2776],[67.81277, 176.3202],[67.97877, 176.3606],[68.14111, 176.3989],[68.30005, 176.4352],[68.45585, 176.4697],[68.60872, 176.5024],[68.75889, 176.5335],[68.90653, 176.563],[69.05176, 176.5911],[69.19467, 176.6179],[69.33527, 176.6433],[69.47351, 176.6676],[69.60926, 176.6907],[69.74228, 176.7127],[69.87224, 176.7337],[69.99869, 176.7538],[70.12104, 176.773],[70.23857, 176.7913],[70.3504, 176.8088],[70.45546, 176.8255],[70.55252, 176.8415],[70.59761, 176.8492]];
var girlsAvgHW = [[3.2322,49.1477],[4.1873,53.6872],[5.1282,57.0673],[5.8458,59.8029],[6.4237,62.0899],[6.8985,64.0301],[7.297,65.7311],[7.6422,67.2873],[7.9487,68.7498],[8.2254,70.1435],[8.48,71.4818],[8.7192,72.771],[8.9481,74.015],[9.1699,75.2176],[9.387,76.3817],[9.6008,77.5099],[9.8124,78.6055],[10.0226,79.671],[10.2315,80.7079],[10.4393,81.7182],[10.6464,82.7036],[10.8534,83.6654],[11.0608,84.604],[11.2688,85.5202],[12.05504,84.97556],[12.29102,86.29026],[12.44469,87.15714],[12.59622,87.99602],[12.74621,88.80551],[12.89517,89.58477],[13.04357,90.33342],[13.19181,91.05154],[13.34023,91.73964],[13.48913,92.39854],[13.63877,93.02945],[13.78937,93.63382],[13.94108,94.21336],[14.09407,94.79643],[14.24844,95.37392],[14.40429,95.94693],[14.56168,96.51645],[14.72064,97.08337],[14.88121,97.64848],[15.04341,98.21247],[15.20721,98.77593],[15.37263,99.3394],[15.53962,99.90331],[15.70817,100.4681],[15.87824,101.0339],[16.04978,101.6012],[16.22277,102.17],[16.39715,102.7406],[16.57289,103.313],[16.74994,103.8873],[16.92827,104.4635],[17.10783,105.0415],[17.28859,105.6213],[17.47052,106.2029],[17.65361,106.7861],[17.83782,107.3707],[18.02314,107.9566],[18.20956,108.5436],[18.39709,109.1316],[18.58571,109.7202],[18.77545,110.3092],[18.96631,110.8984],[19.15831,111.4876],[19.35149,112.0764],[19.54588,112.6646],[19.74151,113.2519],[19.93843,113.838],[20.1367,114.4226],[20.33636,115.0055],[20.53748,115.5863],[20.74013,116.1648],[20.94438,116.7406],[21.1503,117.3136],[21.35797,117.8833],[21.56748,118.4496],[21.77891,119.0123],[21.99235,119.571],[22.20789,120.1254],[22.42562,120.6755],[22.64564,121.221],[22.86804,121.7617],[23.09293,122.2974],[23.32039,122.8279],[23.55052,123.3531],[23.78342,123.8728],[24.01918,124.387],[24.25789,124.8956],[24.49965,125.3985],[24.74454,125.8956],[24.99264,126.3869],[25.24403,126.8724],[25.4988,127.3522],[25.75702,127.8263],[26.01874,128.2947],[26.28404,128.7576],[26.55298,129.2152],[26.82559,129.6675],[27.10193,130.1148],[27.38203,130.5574],[27.66593,130.9954],[27.95365,131.4293],[28.24521,131.8593],[28.5406,132.2859],[28.83984,132.7094],[29.14291,133.1304],[29.4498,133.5493],[29.76048,133.9667],[30.07493,134.3832],[30.39308,134.7995],[30.7149,135.2163],[31.04032,135.6342],[31.36928,136.054],[31.70168,136.4766],[32.03745,136.9027],[32.37649,137.3333],[32.71868,137.7691],[33.06392,138.2112],[33.41208,138.6602],[33.76303,139.1172],[34.11663,139.5829],[34.47272,140.0581],[34.83116,140.5435],[35.19176,141.0397],[35.55437,141.5472],[35.9188,142.0664],[36.28486,142.5974],[36.65236,143.1404],[37.02111,143.695],[37.39089,144.2609],[37.76149,144.8376],[38.1327,145.424],[38.5043,146.0192],[38.87605,146.6217],[39.24775,147.23],[39.61914,147.8424],[39.99,148.4569],[40.36009,149.0714],[40.72918,149.6839],[41.09701,150.292],[41.46336,150.8936],[41.82798,151.4866],[42.19063,152.0687],[42.55108,152.6381],[42.90909,153.193],[43.26442,153.7317],[43.61683,154.2529],[43.96612,154.7555],[44.31204,155.2385],[44.65437,155.7012],[44.99291,156.1432],[45.32745,156.5643],[45.65777,156.9644],[45.98369,157.3437],[46.30501,157.7025],[46.62155,158.0411],[46.93314,158.3603],[47.23962,158.6606],[47.54083,158.9427],[47.83661,159.2075],[48.12685,159.4557],[48.41141,159.6882],[48.69018,159.9058],[48.96305,160.1094],[49.22993,160.2997],[49.49075,160.4777],[49.74544,160.6441],[49.99394,160.7995],[50.23621,160.9449],[50.47222,161.0808],[50.70196,161.2079],[50.92541,161.3268],[51.14259,161.4381],[51.35353,161.5423],[51.55825,161.6399],[51.75681,161.7315],[51.94926,161.8174],[52.13568,161.898],[52.31616,161.9738],[52.4908,162.045],[52.6597,162.112],[52.82299,162.1752],[52.98079,162.2347],[53.13327,162.2908],[53.28056,162.3439],[53.42284,162.394],[53.56028,162.4414],[53.69307,162.4862],[53.82138,162.5287],[53.94544,162.569],[54.06543,162.6072],[54.18158,162.6435],[54.29411,162.6781],[54.40324,162.7109],[54.50921,162.7421],[54.61224,162.7719],[54.71257,162.8002],[54.81044,162.8273],[54.9061,162.8531],[54.99978,162.8778],[55.09172,162.9013],[55.18217,162.9238],[55.27135,162.9454],[55.35951,162.966],[55.44686,162.9858],[55.53362,163.0047],[55.62001,163.0228],[55.70624,163.0402],[55.79248,163.0569],[55.87892,163.0729],[55.96573,163.0882],[56.05305,163.103],[56.141,163.1172],[56.2297,163.1308],[56.31922,163.1439],[56.40963,163.1565],[56.50096,163.1686],[56.5932,163.1802],[56.68633,163.1914],[56.78026,163.2022],[56.8749,163.2126],[56.9701,163.2226],[57.06565,163.2322],[57.16132,163.2415],[57.2568,163.2504],[57.35176,163.259],[57.44578,163.2673],[57.5384,163.2753],[57.6291,163.283],[57.71728,163.2904],[57.80227,163.2976],[57.88334,163.3045],[57.95967,163.3111],[58.0304,163.3175],[58.09453,163.3237],[58.15104,163.3297],[58.19877,163.3354],[58.21897,163.3383]];


var patientData = {}

setPatientData()
function setPatientData() {
	patientData = {
		age : "",
		front_affected_areas : [],
		back_affected_areas : []
	}

	var labelsToElements = {}

	// page two - body parts selection
	Array.from(document.getElementsByClassName("body-part-fill")).forEach(part => {
		var [_bodyPartType,_bodyPartArr] = getBodyPartData(part.parentElement);

		_bodyPartType = _bodyPartType.slice(6);
		if (labelsToElements[_bodyPartType]) {
			labelsToElements[_bodyPartType].push(part)
		} else {
			labelsToElements[_bodyPartType] = [part]
		}

		part.onclick = ((bodyPartType, bodyPartArr) => () => {
			// console.log(bodyPartType)
			labelsToElements[bodyPartType].forEach(p => {
				p.classList.toggle("filled")
			})
			
			var foundElement = false;

			for (var i = 0; i < bodyPartArr.length; i++) {
				if (bodyPartArr[i] == bodyPartType) {
					bodyPartArr.splice(i,1)
					foundElement = true;
				}
			}

			if (!foundElement) {
				bodyPartArr.push(bodyPartType)
			}
		})(_bodyPartType,_bodyPartArr)
	})

}



var shouldAutofillHW = false;

setTimeout(loadTextAnswers, 100)

function openAgeSexPrompt() {
	document.getElementById("main-page1-dialog").classList.add("hidden")
	document.getElementById("secondary-page1-dialog").classList.remove("hidden")
	shouldAutofillHW = true;
	document.getElementById("proceed-button").classList.add("hidden");
}
function closeAgeSexPrompt() {
	shouldAutofillHW = false;
	showProceedForPg1Inputs()
	document.getElementById("main-page1-dialog").classList.remove("hidden")
	document.getElementById("secondary-page1-dialog").classList.add("hidden")
}

function onAgeYearsInputUpdate(el) {
	localStorage.setItem('age_years',el.value);
	patientData.age_years = parseInt(el.value);
	updateAutofillButton()
}

function updateAutofillButton() {
	var months = parseInt(document.getElementById("age-input-months").value);

	if (patientData.age_years*12+months > 90) {
		document.getElementById('adult-front-parent').classList.remove("hidden");
		document.getElementById('adult-back-parent').classList.remove("hidden");
		document.getElementById('front-parent').classList.add("hidden");
		document.getElementById('back-parent').classList.add("hidden");
	} else {
		document.getElementById('adult-front-parent').classList.add("hidden");
		document.getElementById('adult-back-parent').classList.add("hidden");
		document.getElementById('front-parent').classList.remove("hidden");
		document.getElementById('back-parent').classList.remove("hidden");
	}

	if (patientData.age_years*12+months >= 20*12) {
		document.getElementById('age-error').classList.remove('hidden')
		document.getElementById('autofill-button').disabled = true;
	} else {
		document.getElementById('age-error').classList.add('hidden')
		document.getElementById('autofill-button').disabled = !(document.getElementById("sex-input").value != 'none' && document.getElementById("sex-input").value != '' && (document.getElementById("age-input-years").value != 0 || document.getElementById("age-input-months").value != 0))
	}
}


function onSexInputUpdate(el) {
	localStorage.setItem('sex',el.value);
	updateAutofillButton()
}

function onWeightPoundsInputUpdate(el) {
	patientData.weight_lbs = getNaNCheckedValue(parseInt(el.value));
	localStorage.setItem('weight_lbs',patientData.weight_lbs);
	showProceedForPg1Inputs()
}

function onHeightFeetInputUpdate(el) {
	patientData.height_feet = getNaNCheckedValue(parseInt(el.value));
	localStorage.setItem('height_feet', patientData.height_feet);
	showProceedForPg1Inputs()
}

function showProceedForPg1Inputs() {
	if ((parseInt(document.getElementById("height-input-feet").value)*12+parseInt(document.getElementById("height-input-inches").value))*2.54 > 124) {
		document.getElementById('adult-front-parent').classList.remove("hidden");
		document.getElementById('adult-back-parent').classList.remove("hidden");
		document.getElementById('front-parent').classList.add("hidden");
		document.getElementById('back-parent').classList.add("hidden");
	} else {
		document.getElementById('adult-front-parent').classList.add("hidden");
		document.getElementById('adult-back-parent').classList.add("hidden");
		document.getElementById('front-parent').classList.remove("hidden");
		document.getElementById('back-parent').classList.remove("hidden");
	}

	// console.log(document.getElementById("weight-input-pounds").value, document.getElementById("weight-input-ounces").value, document.getElementById("height-input-feet").value, document.getElementById("height-input-inches").value,(document.getElementById("weight-input-pounds").value != 0 || document.getElementById("weight-input-ounces").value != 0) && (document.getElementById("height-input-feet").value != 0 || document.getElementById("height-input-inches").value != 0))

	if ((document.getElementById("weight-input-pounds").value != 0 || document.getElementById("weight-input-ounces").value != 0) && (document.getElementById("height-input-feet").value != 0 || document.getElementById("height-input-inches").value != 0))
		proceedButton.classList.remove('hidden');
	else
		proceedButton.classList.add('hidden');
}

function getNaNCheckedValue(v) {
	return !isNaN(v) ? v : 0;
}

function autofillHeightAndWeight() {
	Array.from(document.getElementsByClassName("restart-button")).forEach(button => button.classList.remove("hidden"));
	doTransitionAndAgeComputation();
	proceedButton.classList.remove('hidden');

	var months = parseInt(document.getElementById("age-input-months").value);
	var sex = document.getElementById("sex-input").value;

	if (patientData.age_years == undefined)
		patientData.age_years = getNaNCheckedValue(parseInt(document.getElementById("age-input-years").value));

	document.getElementById("ftu-explanation").innerHTML = `For an average ${sex} `+(patientData.age_years == 0 ? `${months} month` : `${patientData.age_years} year`)+' old, you can:'

	var el = (sex == "male" ? boysAvgHW : girlsAvgHW)[patientData.age_years*12+months]
	patientData.weight = el[0];
	patientData.height = el[1];
}





var isBodyReversed = false;

const proceedButton = document.getElementById("proceed-button");

function goBackOneStep(button) {
	if (document.getElementById("page-2").classList.contains("fadeout")) {
		document.getElementById("page-2").classList.remove("fadeout")
		document.getElementById("page-3").classList.add("hidden")
		document.getElementById("page-3").classList.remove("fadein")
		proceedButton.classList.remove('hidden');
		document.getElementById("total-ftu").classList.remove("start-anim");
	} else if (document.getElementById("page-1").classList.contains("fadeout")) {
		document.getElementById("restart-button-bar").classList.add("hidden");
		document.getElementById("page-1").classList.remove("fadeout")
		document.getElementById("page-2").classList.add("hidden")
		document.getElementById("page-2").classList.remove("fadein")
		button.classList.add("hidden");
		if (shouldAutofillHW || (document.getElementById("weight-input-pounds").value == 0 && document.getElementById("weight-input-ounces").value == 0) || (document.getElementById("height-input-feet").value == 0 && document.getElementById("height-input-inches").value == 0))
			proceedButton.classList.add('hidden');
	}
}



// page one - age selection
Array.from(document.getElementsByClassName("age-select-option")).forEach(button => {
	button.onclick = () => {
		patientData.age = button.innerHTML;
		document.getElementById("page-1").classList.add("fadeout")
		document.getElementById("page-2").classList.add("fadein")
		document.getElementById("page-2").classList.remove("hidden")
		document.getElementById("back-button").classList.remove("hidden");
		proceedButton.classList.remove('hidden');
	}
})

function getBodyPartData(part) {
	var bodyPartType = part.getAttribute("data-parttype");
	var bodyPartArr;
	if (isBodyReversed) {
		// if the body is reversed, switch left to right and right to left (using an intermediate symbol)
		bodyPartArr = patientData.back_affected_areas;
	} else {
		bodyPartArr = patientData.front_affected_areas;
	}
	return [bodyPartType,bodyPartArr];
}

//   reversing the body diagram
function reverseBodyDiagram(button) {
	const bodyDiagramViewName = document.getElementById("body-diagram-viewname");
	isBodyReversed = !isBodyReversed;
	// if (button.children[1].innerHTML == "Switch to Back") {
	// 	button.children[1].innerHTML = "Switch to Front";
	// 	bodyDiagramViewName.innerHTML = "Back View";
	// } else {
	// 	button.children[1].innerHTML = "Switch to Back"
	// 	bodyDiagramViewName.innerHTML = "Front View";
	// }
	document.getElementById("front-parent").classList.toggle("hidden")
	document.getElementById("back-parent").classList.toggle("hidden")

	// load in the data for new reversed side
	Array.from(document.getElementsByClassName("body-part-fill")).forEach(part => {
		var [bodyPartType,bodyPartArr] = getBodyPartData(part.parentElement);
		if (bodyPartArr.includes(bodyPartType)) {
			part.classList.add("filled");
		} else {
			part.classList.remove("filled");
		}
	})
}
var percentageDataTable = {
	"3-11 months" : {'A' : 1.25,'B' : 1.25,'C' : 11.5,'D' : 1,'E' : 3.25,'F' : 1.5,'G' : 1,'H' : 1,'I' : 1.25,'J' : 1.25,'K' : 1,'L' : 1,'M' : 1.5,'N' : 3.25,'O' : 3.25,'P' : 3.25,'Q' : 1,'R' : 2.25,'S' : 1,'T' : 2,'U' : 1.75,'V' : 2.25,'W' : 1,'X' : 2,'Y' : 1.75,'C' : 11.5,'Dp' : 1,'Ep' : 3.25,'Fp' : 1.5,'Gp' : 1,'Hp' : 1,'Ip' : 1.25,'Jp' : 1.25,'Kp' : 1,'Lp' : 1,'Mp' : 1.5,'Np' : 3.25,'Op' : 3.25,'Pp' : 3.25,'Qp' : 2.5,'Z' : 2.5,'Rp' : 2.25,'Sp' : 1,'Tp' : 2,'Up' : 1.75,'Vp' : 2.25,'Wp' : 1,'Xp' : 2,'Yp' : 1.75},
	"1-5 years" : {'A' : 1.25,'B' : 1.25,'C' : 10,'D' : 1,'E' : 3.25,'F' : 1.5,'G' : 1,'H' : 1,'I' : 1.25,'J' : 1.25,'K' : 1,'L' : 1,'M' : 1.5,'N' : 3.25,'O' : 3.25,'P' : 3.25,'Q' : 1,'R' : 2.75,'S' : 1,'T' : 2,'U' : 1.75,'V' : 2.75,'W' : 1,'X' : 2,'Y' : 1.75,'C' : 10,'Dp' : 1,'Ep' : 3.25,'Fp' : 1.5,'Gp' : 1,'Hp' : 1,'Ip' : 1.25,'Jp' : 1.25,'Kp' : 1,'Lp' : 1,'Mp' : 1.5,'Np' : 3.25,'Op' : 3.25,'Pp' : 3.25,'Qp' : 2.5,'Z' : 2.5,'Rp' : 2.75,'Sp' : 1,'Tp' : 2,'Up' : 1.75,'Vp' : 2.75,'Wp' : 1,'Xp' : 2,'Yp' : 1.75},
	"6-7.5 years" : {'A' : 1.25,'B' : 1.25,'C' : 8,'D' : 1,'E' : 3.25,'F' : 1.5,'G' : 1,'H' : 1,'I' : 1.25,'J' : 1.25,'K' : 1,'L' : 1,'M' : 1.5,'N' : 3.25,'O' : 3.25,'P' : 3.25,'Q' : 1,'R' : 3.5,'S' : 1,'T' : 2.25,'U' : 1.75,'V' : 3.5,'W' : 1,'X' : 2.25,'Y' : 1.75,'C' : 8,'Dp' : 1,'Ep' : 3.25,'Fp' : 1.5,'Gp' : 1,'Hp' : 1,'Ip' : 1.25,'Jp' : 1.25,'Kp' : 1,'Lp' : 1,'Mp' : 1.5,'Np' : 3.25,'Op' : 3.25,'Pp' : 3.25,'Qp' : 2.5,'Z' : 2.5,'Rp' : 3.5,'Sp' : 1,'Tp' : 2.25,'Up' : 1.75,'Vp' : 3.5,'Wp' : 1,'Xp' : 2.25,'Yp' : 1.75},
	"7.5-14.9 years" : {'A' : 1.25,'B' : 1.25,'C' : 6.5,'D' : 1,'E' : 3.25,'F' : 1.5,'G' : 1,'H' : 1,'I' : 1.25,'J' : 1.25,'K' : 1,'L' : 1,'M' : 1.5,'N' : 3.25,'O' : 3.25,'P' : 3.25,'Q' : 1,'R' : 3.75,'S' : 1,'T' : 2.5,'U' : 1.75,'V' : 3.75,'W' : 1,'X' : 2.5,'Y' : 1.75,'C' : 6.5,'Dp' : 1,'Ep' : 3.25,'Fp' : 1.5,'Gp' : 1,'Hp' : 1,'Ip' : 1.25,'Jp' : 1.25,'Kp' : 1,'Lp' : 1,'Mp' : 1.5,'Np' : 3.25,'Op' : 3.25,'Pp' : 3.25,'Qp' : 2.5,'Z' : 2.5,'Rp' : 3.75,'Sp' : 1,'Tp' : 2.5,'Up' : 1.75,'Vp' : 3.75,'Wp' : 1,'Xp' : 2.5,'Yp' : 1.75},
	'15-17.9 years' : {'A' : 1.25,'B' : 1.25,'C' : 5.5,'D' : 1,'E' : 3.25,'F' : 1.5,'G' : 1,'H' : 1,'I' : 1.25,'J' : 1.25,'K' : 1,'L' : 1,'M' : 1.5,'N' : 3.25,'O' : 3.25,'P' : 3.25,'Q' : 1,'R' : 4,'S' : 1,'T' : 2.75,'U' : 1.75,'V' : 4,'W' : 1,'X' : 2.75,'Y' : 1.75,'C' : 5.5,'Dp' : 1,'Ep' : 3.25,'Fp' : 1.5,'Gp' : 1,'Hp' : 1,'Ip' : 1.25,'Jp' : 1.25,'Kp' : 1,'Lp' : 1,'Mp' : 1.5,'Np' : 3.25,'Op' : 3.25,'Pp' : 3.25,'Qp' : 2.5,'Z' : 2.5,'Rp' : 4,'Sp' : 1,'Tp' : 2.75,'Up' : 1.75,'Vp' : 4,'Wp' : 1,'Xp' : 2.75,'Yp' : 1.75},
	'18+ years' : {'A' : 1.25,'B' : 1.25,'C' : 4,'D' : 1,'E' : 3.25,'F' : 1.5,'G' : 1,'H' : 1,'I' : 1.25,'J' : 1.25,'K' : 1,'L' : 1,'M' : 1.5,'N' : 3.25,'O' : 3.25,'P' : 3.25,'Q' : 1,'R' : 4.25,'S' : 1,'T' : 3,'U' : 1.75,'V' : 4.25,'W' : 1,'X' : 3,'Y' : 1.75,'C' : 4,'Dp' : 1,'Ep' : 3.25,'Fp' : 1.5,'Gp' : 1,'Hp' : 1,'Ip' : 1.25,'Jp' : 1.25,'Kp' : 1,'Lp' : 1,'Mp' : 1.5,'Np' : 3.25,'Op' : 3.25,'Pp' : 3.25,'Qp' : 2.5,'Z' : 2.5,'Rp' : 4.25,'Sp' : 1,'Tp' : 3,'Up' : 1.75,'Vp' : 4.25,'Wp' : 1,'Xp' : 3,'Yp' : 1.75}
}

var combinedRegions = [
['I', 'J', 'Ip', 'Jp'],
['F', 'G', 'H', 'M', 'L', 'K', 'Fp', 'Gp', 'Hp', 'Mp', 'Lp', 'Kp'],
['C'],
['A', 'B'],
['D', 'Dp'],
['E', 'N', 'O', 'P'],
['Ep', 'Np', 'Op', 'Pp'],
['Q'],
['Qp', 'Z'],
['V', 'W', 'X', 'R', 'S', 'T', 'Vp', 'Wp', 'Xp', 'Rp', 'Sp', 'Tp'],
['Y', 'U','Yp', 'Up']
]

function calculateBSA(weight, height) {
	return 0.007184 * (weight**.425) * (height**.725);
}

function calculateTotalFTU(BSA) {
	return BSA/0.0312
}


function doTransitionAndAgeComputation() {
	// do transition
	document.getElementById("page-1").classList.add("fadeout")
	document.getElementById("page-2").classList.add("fadein")
	document.getElementById("page-2").classList.remove("hidden")
	document.getElementById("back-button").classList.remove("hidden");

	// make height, age, and weight calculations
	if (patientData.age_years < 1)
		patientData.age = "3-11 months"
	else if (patientData.age_years < 6)
		patientData.age = "1-5 years"
	else if (patientData.age_years < 8)
		patientData.age = "6-7.5 years"
	else if (patientData.age_years < 15)
		patientData.age = "7.5-14.9 years"
	else if (patientData.age_years < 18)
		patientData.age = '15-17.9 years'
	else
		patientData.age = '18+ years'
	// console.log(patientData.age)
}


function proceedToCalculation() {
	Array.from(document.getElementsByClassName("restart-button")).forEach(button => button.classList.remove("hidden"));
	// if proceeding from page-1
	if (!document.getElementById("page-1").classList.contains("fadeout")) {
		doTransitionAndAgeComputation();

		var ounces = parseInt(document.getElementById("weight-input-ounces").value);
		var inches = parseInt(document.getElementById("height-input-inches").value);


		if (patientData.weight_lbs == undefined)
			patientData.weight_lbs = getNaNCheckedValue(parseInt(document.getElementById("weight-input-pounds").value));
		if (patientData.height_feet == undefined)
			patientData.height_feet = getNaNCheckedValue(parseInt(document.getElementById("height-input-feet").value));
		
		// console.log('height-feet',patientData.height_feet)
		var kg = (patientData.weight_lbs+ounces/16)*0.45359237;
		// console.log(kg)
		var cm = (patientData.height_feet*12+inches)*2.54;
		patientData.weight = kg;
		patientData.height = cm;
		// console.log(patientData)
		document.getElementById("ftu-explanation").innerHTML = `For a child ${Math.round((patientData.weight_lbs+ounces/16)*10)/10} lbs and ${patientData.height_feet*12+inches} in, you can:`
		return
	}


	// console.log(patientData.weight,patientData.height)
	var totalFTU = calculateTotalFTU(calculateBSA(patientData.weight,patientData.height))

	// keep track of the total selected area for each region
	var areaTotals = [
		{part : 'hands', area : 0},
		{part : 'arms', area : 0},
		{part : 'scalp', area : 0},
		{part : 'cheeks', area : 0},
		{part : 'neck', area : 0},
		{part : 'front of the torso', area : 0},
		{part : 'back of the torso', area : 0},
		{part : 'genitals', area : 0},
		{part : 'buttocks', area : 0},
		{part : 'legs', area : 0},
		{part : 'feet', area : 0}
	]


	// get the element to put instructions in	
	const instructionContainer = document.getElementById('ftu-instructions');
	// clear the container
	instructionContainer.innerHTML = "";

	// variable for fade in animation
	var accumulatedTime = 0;


	function calculateAreas(areaName,i) {
		var percentage = percentageDataTable[patientData.age][areaName];
		for (var i = 0; i < combinedRegions.length; i++) {
			if (combinedRegions[i].includes(areaName)) {
				areaTotals[i].area += percentage;
				return
			}
		}
		
	}
	// console.log(patientData)
	patientData.front_affected_areas.forEach(calculateAreas)
	patientData.back_affected_areas.forEach(calculateAreas)

	accumulatedTime++;
	document.getElementById("total-ftu").style["animation-delay"] = (accumulatedTime)/10+.4+'s';
	accumulatedTime++;
	document.getElementById("one-week-ftu").style["animation-delay"] = (accumulatedTime)/10+.4+'s';
	document.getElementById("two-week-ftu").style["animation-delay"] = (accumulatedTime)/10+.4+'s';
	accumulatedTime++;
	document.getElementById("ftu-explanation").classList.add("start-anim");
	document.getElementById("ftu-explanation").style["animation-delay"] = (accumulatedTime)/10+.4+'s';
	// console.log(areaTotals)
	var regionFTUSum = 0;
	for (var t of areaTotals) {
		if (t.area == 0) continue;
		// console.log(totalFTU)
		var regionFTU = t.area/100*totalFTU;
		// console.log(regionFTU)
		regionFTUSum += regionFTU;

		// create a new span for an instruction
		var instruction = document.createElement('span');
		accumulatedTime++;
		instruction.style["animation-delay"] = accumulatedTime/10+.4+'s';
		var fl = Math.floor(regionFTU*2)/2;
		var ce = Math.ceil(regionFTU*2)/2;
		if (ce != 0) {
			if (fl == ce)
				instruction.innerHTML = `Use <b>${fl} finger tip units</b> on the ${t.part}.`;
			else {
				if (fl == 0)
					instruction.innerHTML = `Use <b>up to ${ce} finger tip units</b> on the ${t.part}.`;
				else
					instruction.innerHTML = `Use <b>${fl} - ${ce} finger tip units</b> on the ${t.part}.`;
			}
		}
		
		instructionContainer.appendChild(instruction)
	}
	document.getElementById("total-ftu").classList.add("start-anim");
	regionFTUSum = Math.round(regionFTUSum)
	document.getElementById("total-ftu").innerHTML = "In total, you can use approximately <b>"+regionFTUSum+" Finger Tip Units (FTUs)</b> per treatment.";

	
	document.getElementById("one-week-ftu").innerHTML = "If applied twice daily, that is <b>"+Math.round(regionFTUSum*2*7*.5)+"g</b> of topical steroid for 1 week";
	document.getElementById("one-week-ftu").classList.add("start-anim");
	document.getElementById("two-week-ftu").innerHTML = "and <b>"+Math.round(regionFTUSum*2*7*.5*2)+"g</b> of topical steroid for 2 weeks.";
	document.getElementById("two-week-ftu").classList.add("start-anim");
	

	document.getElementById("page-2").classList.add("fadeout")
	document.getElementById("page-3").classList.add("fadein")
	document.getElementById("page-3").classList.remove("hidden")
	// var totalSpan = document.createElement('span');

	// totalSpan.style="font-weight: bold";
	// totalSpan.style["animation-delay"] = (accumulatedTime+2)/10+.4+'s';

	// totalSpan.innerHTML = `That is a total of ${total} fingertip units, which is within the normal amount for your child.`;

	// instructionContainer.appendChild(document.createElement('br'))
	// instructionContainer.appendChild(totalSpan)
	proceedButton.classList.add('hidden');

}
function updateStorage(inp, key) {
	localStorage.setItem(key,inp.value);
}

function loadAnswer(storageKey,inputId,patientDataKey="",isInt=true) {
	var val = localStorage.getItem(storageKey);
	if (isInt)
		val = parseInt(val)

	// console.log(val,inputId,patientDataKey)
	if (patientDataKey.length > 0 && !isNaN(val))
		patientData[patientDataKey] = val;
	if (!isInt || !isNaN(val))
		document.getElementById(inputId).value = val;
	else
		document.getElementById(inputId).value = patientDataKey.length > 0 ? 0 : 0;
}

function loadTextAnswers() {
	// console.log(Object.assign({},patientData))
	loadAnswer('weight_lbs','weight-input-pounds','weight_lbs');
	loadAnswer('weight_oz','weight-input-ounces');
	loadAnswer('height_feet','height-input-feet','height_feet');
	loadAnswer('height_inches','height-input-inches');

	loadAnswer('age_years','age-input-years','age_years');
	loadAnswer('age_months','age-input-months');
	loadAnswer('sex','sex-input','',false);
	updateAutofillButton()

	// if (localStorage.getItem('has_visited_aticus') == 'set')
	// 	document.getElementById("disclaimer-modal").classList.add('hidden')

	showProceedForPg1Inputs();
}

function restartProgress(button) {
	localStorage.removeItem('weight_lbs')
	localStorage.removeItem('weight_oz')
	localStorage.removeItem('height_feet')
	localStorage.removeItem('height_inches')
	localStorage.removeItem('age_years')
	localStorage.removeItem('age_months')
	localStorage.removeItem('sex')
	localStorage.removeItem('has_visited_aticus')

	setPatientData()
	shouldAutofillHW = false;

	document.getElementById("page-2").classList.remove("fadeout")
	document.getElementById("page-3").classList.add("hidden")
	document.getElementById("page-3").classList.remove("fadein")
	proceedButton.classList.add('hidden');
	document.getElementById('back-button').classList.add('hidden');
	document.getElementById("page-1").classList.remove("fadeout")
	document.getElementById("page-2").classList.add("hidden")
	document.getElementById("page-2").classList.remove("fadein")

	loadTextAnswers()

	Array.from(document.getElementsByClassName("restart-button")).forEach(button => button.classList.add("hidden"));

	closeAgeSexPrompt()

	Array.from(document.getElementsByClassName("body-part-fill")).forEach(part => {
		part.classList.remove("filled")
	})
}

function agreeToDisclaimer() {
	document.getElementById("disclaimer-modal").classList.add('hidden')
	localStorage.setItem('has_visited_aticus','set')
}